<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Panel Multifirma - Demo</title>
  <style>
    body{font-family:Inter,system-ui,Arial;margin:20px;background:#fafafa;color:#222}
    .pr{border:1px solid #ddd;padding:12px;margin:10px 0;border-radius:12px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
    .green{background:#e6ffed}
    .yellow{background:#fffbe6}
    .red{background:#ffe6e6}
    .alert{background:#ffdddd;color:#900;padding:8px;border-radius:8px;margin-top:6px;font-weight:600}
    .meta{font-size:0.9em;color:#555}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:600;margin-right:6px;background:#eee}
    button{background:#2563eb;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-weight:600}
    button:hover{background:#1e40af}
  </style>
</head>
<body>
  <h2>üö¶ Panel multifirma ‚Äî Demo r√°pida</h2>
  <div>Repositorio: <strong id="repoLabel"></strong></div>
  <div id="container"></div>
  <div id="lastUpdate" style="margin-top:10px;font-size:0.9em;color:#666"></div>

<script>
const owner = "04anamaria";   // <-- tu usuario de GitHub
const repo  = "netmon";       // <-- tu repositorio
document.getElementById('repoLabel').innerText = `${owner}/${repo}`;

// üîπ Guardar las aprobaciones simuladas en memoria temporal
const simulatedApprovals = {};

async function api(path){
  const url = `https://api.github.com/repos/${owner}/${repo}${path}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(await res.text());
  return res.json();
}

function stateClass(state){ return state==="green"?"green": state==="yellow"?"yellow":"red"; }

// üî∏ Funci√≥n principal que construye el panel
async function build(){
  const prs = await api('/pulls?state=open');
  const cont = document.getElementById('container');
  cont.innerHTML = '';
  for(const pr of prs){
    const commits = await fetch(pr.commits_url).then(r=>r.json());
    const reviews = await fetch(pr.url + '/reviews').then(r=>r.json());
    const signed = commits.length>0 && commits.every(c => c.commit && c.commit.verification && c.commit.verification.verified === true);
    const approvers = new Set(reviews.filter(r=>r.state==="APPROVED").map(r=>r.user.login));
    let approvals = approvers.size;

    // ‚úÖ Simulaci√≥n de aprobaci√≥n
    const simulated = simulatedApprovals[pr.number] || 0;
    approvals += simulated;

    // üîπ Estado del an√°lisis (simulado)
    let sast = "success";

    // üî∏ L√≥gica de colores del estado general
    let state = "red";
    if(!signed || sast==="failure") state="red";
    else if(signed && approvals<2) state="yellow";
    else if(signed && approvals>=2 && sast==="success") state="green";

    // ‚ö†Ô∏è Alerta si el PR tiene m√°s de 3 d√≠as abierto y menos de 2 aprobaciones
    const created = new Date(pr.created_at);
    const daysOpen = (Date.now() - created.getTime()) / (1000*60*60*24);
    const alert = (daysOpen > 3 && approvals < 2);

    // üß± Construir el bloque visual
    const div = document.createElement('div');
    div.className = 'pr ' + stateClass(state);
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>PR #${pr.number} ‚Äî ${pr.title}</strong>
          <div class="meta">Autor: ${pr.user.login} ‚Ä¢ SHA: ${pr.head.sha.slice(0,7)} ‚Ä¢ Abierto hace ${daysOpen.toFixed(1)} d√≠as</div>
        </div>
        <div style="text-align:right">
          <div class="badge">${signed? '‚úÖ Firmado':'‚ùå Sin firma'}</div>
          <div class="badge">üë• ${approvals}/2 aprobaciones</div>
          <div class="badge">SAST: ${sast}</div>
        </div>
      </div>
      <div style="margin-top:8px">${pr.body? pr.body.slice(0,220):''}</div>
      <div style="margin-top:8px;">
        <button onclick="simulateApprove(${pr.number})">+1 aprobaci√≥n (simular)</button>
        <button onclick="resetSim(${pr.number})" style="background:#9ca3af">Reset simulaci√≥n</button>
      </div>
      ${alert ? `<div class="alert">‚ö†Ô∏è ALERTA: PR estancado ‚Äî ${daysOpen.toFixed(0)} d√≠as abierto sin aprobar.</div>` : ''}
    `;
    cont.appendChild(div);
  }

  document.getElementById('lastUpdate').innerText = "√öltima actualizaci√≥n: " + new Date().toLocaleTimeString();
}

// üîπ Funciones auxiliares
function simulateApprove(num){
  simulatedApprovals[num] = (simulatedApprovals[num] || 0) + 1;
  build();
}
function resetSim(num){
  simulatedApprovals[num] = 0;
  build();
}

// üîÑ Autoactualizaci√≥n cada 30 segundos
build();
setInterval(build, 30000);
</script>
</body>
</html>
